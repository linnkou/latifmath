<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رفع الملفات</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            direction: rtl;
        }
        .upload-form {
            margin: 20px auto;
            width: 80%;
            max-width: 600px;
        }
        .upload-form input[type="file"] {
            margin: 10px 0;
        }
        .file-list {
            margin-top: 20px;
        }
        .file-list ul {
            list-style-type: none;
            padding: 0;
        }
        .file-list li {
            margin: 10px 0;
        }
        .file-list a {
            text-decoration: none;
            color: #003366;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="upload-form">
        <h1>رفع الملفات</h1>
        <select id="year">
            <option value="first-year">السنة أولى متوسط</option>
            <option value="second-year">السنة ثانية متوسط</option>
            <option value="third-year">السنة ثالثة متوسط</option>
            <option value="fourth-year">السنة رابعة متوسط</option>
        </select>
        <select id="fileType">
            <option value="assignments">فروض</option>
            <option value="lessons">دروس</option>
            <option value="tests">اختبارات</option>
        </select>
        <input type="file" id="fileInput">
        <button onclick="uploadFile()">رفع الملف</button>
        <p id="status"></p>
    </div>

    <div class="file-list">
        <h2>الملفات المرفوعة</h2>
        <ul id="filesList"></ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // تهيئة Supabase
        const supabaseUrl = 'https://metaecgrnzfmvczbuyvt.supabase.co';
        const supabaseKey = 'YOUR_JWT_TOKEN'; // استبدل هذا بالـ JWT Token
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // رفع الملفات
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const year = document.getElementById('year').value;
            const fileType = document.getElementById('fileType').value;
            const status = document.getElementById('status');

            if (fileInput.files.length === 0) {
                status.textContent = "الرجاء اختيار ملف أولاً.";
                return;
            }

            const file = fileInput.files[0];
            const filePath = `${year}/${fileType}/${file.name}`;

            const { data, error } = await supabase
                .storage
                .from('uploads') // اسم الـ Bucket
                .upload(filePath, file); // المسار والملف

            if (error) {
                status.textContent = "حدث خطأ أثناء رفع الملف: " + error.message;
            } else {
                status.textContent = "تم رفع الملف بنجاح!";
                listFiles(); // تحديث قائمة الملفات بعد الرفع
            }
        }

        // عرض الملفات
        async function listFiles() {
            const year = document.getElementById('year').value;
            const fileType = document.getElementById('fileType').value;
            const filesList = document.getElementById('filesList');

            const { data, error } = await supabase
                .storage
                .from('uploads') // اسم الـ Bucket
                .list(`${year}/${fileType}`); // المسار

            if (error) {
                console.error('حدث خطأ أثناء استرداد الملفات:', error);
            } else {
                filesList.innerHTML = ""; // مسح القائمة الحالية
                data.forEach(file => {
                    const listItem = document.createElement("li");
                    listItem.innerHTML = `<a href="#" onclick="downloadFile('${year}/${fileType}/${file.name}')">${file.name}</a>`;
                    filesList.appendChild(listItem);
                });
            }
        }

        // تنزيل الملفات
        async function downloadFile(filePath) {
            const { data, error } = await supabase
                .storage
                .from('uploads') // اسم الـ Bucket
                .download(filePath); // المسار الكامل للملف

            if (error) {
                console.error('حدث خطأ أثناء تنزيل الملف:', error);
            } else {
                const url = URL.createObjectURL(data);
                window.open(url); // فتح الملف في نافذة جديدة
            }
        }

        // تحميل قائمة الملفات عند فتح الصفحة
        listFiles();
    </script>

</body>
</html>
